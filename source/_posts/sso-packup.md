---
title: 单点登录各方案的原理及整理
date: 2021-09-10 17:18:00
updated: 2021-09-10 17:18:00
tags:
---
担任前端开发到现在，负责的项目也根据现场落地情况对接过一些平台的单点登录框架，虽然都是单点登录，前面叫的名不一样，但多少都有一些相同点，原理也基本相同。整理此文档记录遇到的单点登录方案原理及流程，也是为了方便围绕单点登录的工作机制来制定安全的实现方案。目前接触过的主要是: 
**OAuth2框架:** 通过共享认证中心，通过认证中心的cookie来实现第二次免登录。
**同域名Cookie共享:** 同一域名下的应用共享顶级的cookie，直接根据cookie解析用户信息。

## 单点登录本质
单点登录本质是通过存储在客户端的凭证信息（多为cookie）来实现同一单点登录体系下各应用系统的用户信息共享。
共享的方式有：
1. 通过共享认证中心，通过认证中心的cookie来实现第二次免登录。
2. 同一域名下的应用共享顶级的cookie，直接根据cookie解析用户信息。

## 同一域名共享Cookie
通过将同一体系下的应用系统都借助Nginx服务器的地址代理转发，共享同一个域下的cookie来实现用户信息的共享。
在此体系上部署的应用都是通过同一个顶级地址访问的，所以会共享此地址下的cookie，即可通过共享cookie内容处理解析用户信息实现单点登录。
![同域名共享Cookie单点登录流程](https://img3.qq.tc/2022/04/05/cookie.png '同域名共享Cookie单点登录流程')
因为在同一个域下，所以该体系下各应用系统的服务端都可以拿到该域的cookie，即应用系统之间服务端间的通信只需要将前端请求中的cookie构造在跨服务端的请求头中即可实现，不需要特殊实现。

## OAuth2框架
使用OAuth2框架实现的这种单点登录一般需要一个统一的认证中心来鉴权，访问应用系统需要鉴权时，客户端必然会跳转至认证中心鉴权，首次登录时需要输入用户凭证，第二次认证中心会根据cookie判断是否已登录直接跳回对应应用系统。需要注意：认证中心和各应用系统可以不在同一域内，即cookie可能无法共享
也即是说在访问应用系统的时候，客户端是经过认证中心页面鉴权之后才重定向回到的应用系统页面。他们的cookie是不同域的，应用系统的服务端无法在请求中拿到其他域的cookie。
![OAuth2框架单点登录流程](https://img3.qq.tc/2022/04/05/OAuth2.png 'OAuth2框架单点登录流程')
所以此类单点登录的认证都必须在客户端页面上访问认证中心来做鉴权，对于单纯的服务端间通信很不友好，不能像统一运维OP单点那样服务端构造请求的时候将客户端请求头中的cookie装载进去即可，因为服务端是拿不到认证中心域的cookie的。