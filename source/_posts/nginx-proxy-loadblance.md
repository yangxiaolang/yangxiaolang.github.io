---
title: Nginx反向代理和负载均衡
date: 2020-08-07 13:36:00
updated: 2020-08-07 13:36:00
tags:
---
Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，它足够轻量且能承载高并发访问，关键特性就是反向代理和负载均衡。
## 反向代理
负载均衡很好理解，而要理解反向代理可以先聊聊我们最常接触到的正向代理。
我们有时会因为工作需求要访问外网查阅一些资料，但是由于某些不可抗力因素无法访问到外网的。这时我们就需要使用VPN也就是常说的梯子来达到访问外网的目的，而VPN也就是正向代理的一种。以下是正向代理的示意图。
![正向代理](https://s3.bmp.ovh/imgs/2022/04/03/2d3e3e7388a502a9.png "正向代理")
可以看到，正向代理即使客户端通过代理访问目标Web服务器，代理服务器是对Web服务器隐藏了客户端的细节，即Web服务器只知道处理了从代理服务器发来的请求，但不知道发送请求的真正客户端是谁。而客户端很明确是由谁处理了自己的请求。
解释了正向代理，反向代理也就很好理解了。以下是反向代理的示意图。
![反向代理](https://s3.bmp.ovh/imgs/2022/04/03/5262cfbf897d58bb.png "反向代理")
显而易见的，与正向代理恰恰相反，代理服务器对客户端隐藏了目标Web服务器的细节。客户端只知道将请求发到代理服务器处理，却不知道代理服务器将请求交给了哪个Web服务器去处理，甚至以为就是代理服务器处理的自己的请求。
由此，判断正向代理和反向代理的一个很简单的依据就是，代理服务器是对谁隐藏了谁的细节，客户端是否明确是谁真正处理了自己的请求。
## 负载均衡
也正是因为nginx反向代理的特性，也使得它有了另一个为人称道的特性——负载均衡。它可以将处理相同请求的服务器分为一组，当需要处理请求时按照设置好的负责均衡策略将请求交给相应的服务器处理，确保服务器组的负载均衡。
Nginx负载均衡策略分为内置策略和拓展策略。拓展策略主要依靠用户自定义实现，而内置策略则是nginx自己提供的三种策略：
1.  轮询(或加权轮询)
2.  最少连接
3.  Ip_hash
轮询策略很好理解，假设有一个服务器组包含服务器A、服务器B和服务器C。那么处理请求的顺序就是ABCABCABC……。
加权轮询就是就是给服务器组中的服务器增加权重，比如服务器A：3，服务器B：2，服务器C：3。那么此时轮询策略处理请求的顺序就是AAABBCCCAAABBCCC……。可以将普通的轮询当作各服务器的权重都为1的加权轮询。
![轮询和加权轮询](https://s3.bmp.ovh/imgs/2022/04/03/90f2a90ab71a55a1.png "轮询和加权轮询")
最少连接策略也很好理解，nginx服务器在转发请求时会找到正在处理请求最少的服务器将请求转发给这个服务器，保证服务器组中的各个服务器处理的请求数尽量相近达到负载均衡。
Ip_hash策略又称会话持久化，因为最少连接和轮询策略不能保证将相同客户端的请求转发到相同服务器上处理，这可能会导致会话session丢失，所以我们需要将某个客户端的所有请求“粘滞”在特定的服务器上。
![IP哈希](https://s3.bmp.ovh/imgs/2022/04/03/5262cfbf897d58bb.png "IP哈希")
使用 IP 哈希，客户端的 IP 地址用作为哈希键，以确定应用为客户端请求选择服务器组中的哪个服务器。此方法确保了来自同一个客户端的请求始终被定向到同一台服务器，除非该服务器不可用。
以上是nginx内置的负载均衡策略，拓展策略则是根据用户自己的实际场景由自己实现负载均衡算法，在此不做赘述。
